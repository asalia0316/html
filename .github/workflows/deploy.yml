name: Deploy VuePress Docs
on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 关键修复1：使用 VuePress 2.x 要求的 Node.js 20.9.0+（选 20.x LTS 稳定版）
      - name: 设置 Node.js 20.x（满足依赖版本要求）
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.5'  # 与报错中一致的 20.x 版本，确保兼容
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: 查看当前工作目录和文件
        run: |
          pwd
          ls -la  # 确认 package.json 和 package-lock.json 都存在

      # 关键修复2：用 npm install 同步锁文件（代替 npm ci，自动修复锁文件缺失依赖）
      - name: 安装依赖并同步锁文件
        run: npm install  # npm install 会自动更新 package-lock.json，解决 Missing 问题
        env:
          NODE_ENV: production

      - name: 验证依赖安装成功（可选，用于排查）
        run: |
          ls -la node_modules/vuepress/
          ls -la node_modules/vuepress/cli.js  # 确认 cli.js 存在

      # 构建文档（VuePress 2.x 推荐命令，避免路径问题）
      - name: 构建文档
        run: npx vuepress-vite build docs  # 2.x 专用命令，比直接执行 cli.js 更稳定

      # 部署步骤（按需保留）
      - name: 部署到 GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/.vuepress/dist